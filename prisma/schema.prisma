// Orbit CRM Database Schema - Roofing Sales Workflow
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & ORGANIZATION MODELS
// ============================================

model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  fullName              String
  avatarUrl             String?
  activeOrganizationId  String?   // Currently selected organization
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  memberships      OrganizationMember[]
  assignedContacts Contact[] @relation("AssignedTo")
  createdContacts  Contact[] @relation("CreatedBy")
  tasks            Task[]
  notes            Note[]
  appointments     Appointment[]
  joshMessages     JoshMessage[]
  joshDrafts       JoshDraft[]
  connectedGoogleTokens GoogleToken[]
  createdFences    Fence[] @relation("FenceCreatedBy")

  @@map("users")
}

model Organization {
  id             String    @id @default(uuid())
  name           String
  slug           String    @unique
  logoUrl        String?
  officeDays     Int[]     @default([1, 3, 5]) // 1=Mon, 3=Wed, 5=Fri
  inspectionDays Int[]     @default([2, 4])    // 2=Tue, 4=Thu
  
  // Seasonal follow-up settings
  seasonalFollowUpMonth Int?      @default(4)   // Month number (1-12), default April
  seasonalFollowUpDay   Int?      @default(1)   // Day of month (1-31), default 1st
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  members                OrganizationMember[]
  contacts               Contact[]
  leadStages             LeadStage[]
  messageTemplates       MessageTemplate[]
  carriers               Carrier[]
  googleToken            GoogleToken?
  fences                 Fence[]
  customTaskTypes        CustomTaskType[]
  customAppointmentTypes CustomAppointmentType[]
  resourceCompanies      ResourceCompany[]

  @@map("organizations")
}

model OrganizationMember {
  id             String     @id @default(uuid())
  userId         String
  organizationId String
  role           MemberRole @default(MEMBER)
  joinedAt       DateTime   @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("organization_members")
}

enum MemberRole {
  OWNER
  MANAGER
  MEMBER
}

// ============================================
// CONTACT & LEAD MODELS
// ============================================

model Contact {
  id             String    @id @default(uuid())
  organizationId String
  assignedToId   String?
  createdById    String

  // Contact Info
  firstName      String
  lastName       String
  email          String?
  phone          String?
  address        String?
  city           String?
  state          String?
  zipCode        String?
  latitude       Float?
  longitude      Float?

  // Lead Status
  stageId        String?
  stageOrder     Int       @default(0)
  
  // Retail Prospect Fields
  quoteType      String?   // e.g., "Full Roof Replacement", "Repair", "Gutters"
  
  // Claim Prospect Fields (populated when contact becomes claim prospect)
  carrier        String?   // Insurance carrier name (legacy free-text)
  carrierId      String?   // FK to Carrier model
  adjusterEmail  String?   // Per-adjuster email (for PER_ADJUSTER carriers)
  dateOfLoss     DateTime? // Date of the damage/loss event
  policyNumber   String?   // Insurance policy number (manual entry)
  claimNumber    String?   // Insurance claim number (manual entry)
  
  // Seasonal Follow-up
  seasonalReminderDate DateTime? // Date to remind for seasonal follow-up (spring)
  
  // Workflow State Tracking
  firstMessageSentAt DateTime?   // When first message was sent (for follow-up cycle)
  claimRecSentAt     DateTime?   // When claim recommendation was sent
  paSentAt           DateTime?   // When PA agreement was sent
  quoteSentAt        DateTime?   // When quote was sent
  
  // Job Tracking (for Approved status)
  jobStatus         JobStatus?
  jobScheduledDate  DateTime?
  jobCompletedDate  DateTime?
  
  // Metadata
  source         String?   // Where the lead came from
  notes          String?   // Initial notes about the lead
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedTo     User?        @relation("AssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)
  createdBy      User         @relation("CreatedBy", fields: [createdById], references: [id])
  stage          LeadStage?   @relation(fields: [stageId], references: [id], onDelete: SetNull)
  carrierRef     Carrier?     @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  tasks          Task[]
  appointments   Appointment[]
  timeline       Note[]
  files          ContactFile[]
  joshDrafts     JoshDraft[]

  @@index([organizationId])
  @@index([assignedToId])
  @@index([stageId])
  @@index([jobStatus])
  @@index([seasonalReminderDate])
  @@map("contacts")
}

// Job status for approved jobs
enum JobStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
}

// ============================================
// CARRIER MODEL
// ============================================

model Carrier {
  id                    String           @id @default(uuid())
  organizationId        String
  name                  String            // "State Farm", "Allstate", etc.
  emailType             CarrierEmailType  // UNIFIED or PER_ADJUSTER
  unifiedEmail          String?           // e.g., "statefarmfireclaims@statefarm.com"
  requiresClaimInSubject Boolean          @default(true)
  subjectFormat         String?           // e.g., "Claim #{{claimNumber}} - {{customerName}}"
  notes                 String?
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  organization          Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts              Contact[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("carriers")
}

enum CarrierEmailType {
  UNIFIED        // One email for all claims (claim # in subject)
  PER_ADJUSTER   // Unique email per adjuster (prompt user each time)
}

model LeadStage {
  id             String       @id @default(uuid())
  organizationId String
  name           String
  description    String?
  color          String       @default("#6366f1") // Indigo default
  order          Int
  isTerminal     Boolean      @default(false) // True for Approved, Not Interested, Seasonal
  stageType      StageType    @default(ACTIVE)
  workflowType   WorkflowType @default(BOTH) // Which workflow path this stage belongs to
  createdAt      DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts       Contact[]
  taskTypes      CustomTaskType[]

  @@unique([organizationId, name])
  @@map("lead_stages")
}

enum StageType {
  ACTIVE          // Normal active stages
  APPROVED        // Won/Closed
  SEASONAL        // Seasonal follow-up
  NOT_INTERESTED  // Lost/Not interested
}

// Defines which workflow path a stage belongs to
enum WorkflowType {
  RETAIL    // Retail prospect path only
  CLAIM     // Claim prospect path only
  BOTH      // Shared stages (New Lead, Scheduled Inspection, terminal stages)
  TERMINAL  // Terminal stages (Approved, Seasonal, Not Interested)
}

// ============================================
// TASK & FOLLOW-UP MODELS
// ============================================

model Task {
  id          String       @id @default(uuid())
  contactId   String
  userId      String
  
  title       String
  description String?
  dueDate     DateTime
  completedAt DateTime?
  status      TaskStatus   @default(PENDING)
  taskType    String       @default("Follow Up")
  
  quickNotes  String?
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  contact     Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id])
  joshDrafts  JoshDraft[]

  @@index([contactId])
  @@index([userId])
  @@index([dueDate])
  @@index([status])
  @@index([taskType])
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================
// CUSTOM TASK & APPOINTMENT TYPES (user-configurable)
// ============================================

model CustomTaskType {
  id              String       @id @default(uuid())
  organizationId  String
  name            String
  description     String?
  defaultDueDays  Int?
  stageId         String?
  isSystem        Boolean      @default(false)
  order           Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stage           LeadStage?   @relation(fields: [stageId], references: [id], onDelete: SetNull)
  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([stageId])
  @@map("custom_task_types")
}

model CustomAppointmentType {
  id               String       @id @default(uuid())
  organizationId   String
  name             String
  includesLocation Boolean      @default(true)
  isSystem         Boolean      @default(false)
  order            Int          @default(0)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("custom_appointment_types")
}

// ============================================
// APPOINTMENTS (separate from tasks, calendar-only)
// ============================================

model Appointment {
  id              String    @id @default(uuid())
  contactId       String
  userId          String
  title           String
  type            String
  startTime       DateTime
  endTime         DateTime?
  location        String?
  description     String?
  calendarEventId String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  contact         Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id])
  @@index([contactId])
  @@index([userId])
  @@index([startTime])
  @@map("appointments")
}

// ============================================
// NOTES & TIMELINE
// ============================================

model Note {
  id        String   @id @default(uuid())
  contactId String
  userId    String
  
  content   String
  noteType  NoteType @default(NOTE)
  metadata  Json?    // For storing additional info like email details, SMS templates used, etc.
  
  createdAt DateTime @default(now())

  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([contactId])
  @@map("notes")
}

enum NoteType {
  NOTE
  EMAIL_SENT
  EMAIL_RECEIVED      // Email received and linked by Josh
  SMS_SENT
  STAGE_CHANGE
  TASK_COMPLETED
  APPOINTMENT_SCHEDULED
  APPOINTMENT_COMPLETED
  FILE_UPLOADED
  PA_UPLOADED
  QUOTE_SENT
  CLAIM_REC_SENT
  JOB_STATUS_CHANGE
  SYSTEM
  JOSH_CREATED        // Contact created by Josh AI
}

// ============================================
// FILES & ATTACHMENTS
// ============================================

model ContactFile {
  id        String   @id @default(uuid())
  contactId String
  
  fileName  String
  fileUrl   String
  fileType  FileType
  fileSize  Int      // in bytes
  mimeType  String?
  
  // For PA agreements
  isPADocument Boolean @default(false)
  
  createdAt DateTime @default(now())

  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([isPADocument])
  @@map("contact_files")
}

enum FileType {
  PHOTO
  DOCUMENT
  PA_AGREEMENT
}

// ============================================
// MESSAGE TEMPLATES
// ============================================

model MessageTemplate {
  id             String       @id @default(uuid())
  organizationId String
  
  name           String
  subject        String?
  body           String
  templateType   TemplateType
  category       String       @default("General")
  taskTypeName   String?      // Associates template with a custom task type
  stageName      String?      // Associates template with a stage
  variables      Json?
  isDefault      Boolean      @default(false)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([category])
  @@map("message_templates")
}

enum TemplateType {
  SMS
  EMAIL
}

// ============================================
// GOOGLE INTEGRATION (Unified Calendar + Gmail)
// ============================================

model GoogleToken {
  id             String   @id @default(uuid())
  organizationId String   @unique  // One Google account per organization
  connectedById  String             // User who connected the account
  gmailEmail     String?            // The connected Gmail address
  
  accessToken  String
  refreshToken String
  tokenType    String   @default("Bearer")
  expiresAt    DateTime
  
  // Granted scopes (tracks what permissions user has granted)
  hasCalendarAccess Boolean @default(false)
  hasGmailAccess    Boolean @default(false)
  
  // Calendar settings
  calendarId   String   @default("primary") // Which calendar to sync to
  
  // Gmail sync state (for Josh)
  lastGmailHistoryId String?   // Gmail history ID for incremental sync
  lastGmailSyncAt    DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  connectedBy  User         @relation(fields: [connectedById], references: [id])

  @@map("google_tokens")
}

// ============================================
// JOSH AI ASSISTANT
// ============================================

model ProcessedEmail {
  id             String              @id @default(uuid())
  organizationId String
  
  gmailMessageId String              @unique // Gmail message ID to prevent reprocessing
  threadId       String?             // Gmail thread ID for grouping
  fromEmail      String
  fromName       String?
  subject        String?
  snippet        String?             // Email preview text
  receivedAt     DateTime
  
  // Processing results
  status         EmailProcessStatus  @default(PENDING)
  classification EmailClassification?
  contactId      String?             // Linked contact if matched/created
  confidence     Float?              // AI classification confidence
  
  // Raw data for debugging
  rawHeaders     Json?
  
  createdAt      DateTime            @default(now())
  processedAt    DateTime?

  @@index([organizationId])
  @@index([status])
  @@index([contactId])
  @@map("processed_emails")
}

enum EmailProcessStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

enum EmailClassification {
  ACCULYNX_NEW_LEAD    // AccuLynx new lead notification
  CARRIER_EMAIL        // Email from insurance carrier
  CUSTOMER_EMAIL       // Email from existing customer
  NEW_CUSTOMER_EMAIL   // Email from potential new customer
  INTERNAL             // Internal/team email
  SPAM_MARKETING       // Marketing/spam to ignore
  UNKNOWN              // Needs manual review
}

model JoshActivity {
  id             String           @id @default(uuid())
  organizationId String
  userId         String?          // User this activity is for (null = org-wide)
  
  activityType   JoshActivityType
  title          String           // Human-readable title
  description    String?          // Detailed description
  
  // Related entities
  contactId      String?          // Related contact if applicable
  emailId        String?          // Related processed email
  
  // For notifications
  isRead         Boolean          @default(false)
  
  metadata       Json?            // Additional context data
  
  createdAt      DateTime         @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("josh_activities")
}

enum JoshActivityType {
  LEAD_CREATED           // Created a new lead from email
  LEAD_CREATED_ACCULYNX  // Created lead from AccuLynx notification
  EMAIL_LINKED           // Linked email to existing contact
  EMAIL_FLAGGED          // Flagged email for manual review
  CARRIER_EMAIL_RECEIVED // Received email from carrier
  SYNC_COMPLETED         // Completed email sync
  SYNC_ERROR             // Error during sync
}

model JoshMessage {
  id             String          @id @default(uuid())
  organizationId String
  userId         String
  
  role           JoshMessageRole // user or assistant
  content        String
  
  // For assistant messages that reference activities
  activityIds    String[]        // Related JoshActivity IDs
  
  createdAt      DateTime        @default(now())

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
  @@map("josh_messages")
}

enum JoshMessageRole {
  USER
  ASSISTANT
}

// ============================================
// JOSH OUTBOX (Draft messages composed by Josh AI)
// ============================================

model JoshDraft {
  id             String   @id @default(uuid())
  userId         String
  contactId      String
  taskId         String?

  channel        String   // "sms", "email", "both"
  recipientType  String   @default("customer") // "customer", "carrier"
  subject        String?
  body           String
  directive      String   // The original user directive

  draftType      String   @default("message") // "message" | "progress_task" | "add_note" | "set_date"
  actionPayload  Json?    // Structured data for non-message actions

  status         String   @default("pending") // "pending", "sent", "discarded"

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  task    Task?   @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([userId, status])
  @@index([contactId])
  @@map("josh_drafts")
}

// ============================================
// FENCE / TERRITORY MODELS
// ============================================

model Fence {
  id             String   @id @default(uuid())
  organizationId String
  createdById    String
  name           String
  description    String?
  coordinates    Json
  color          String   @default("#3b82f6")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User         @relation("FenceCreatedBy", fields: [createdById], references: [id])

  @@index([organizationId])
  @@map("fences")
}

// ============================================
// RESOURCE CONTACTS (suppliers, subs, adjusters, etc.)
// ============================================

model ResourceCompany {
  id             String    @id @default(uuid())
  organizationId String
  name           String
  type           String    // "Supplier", "Subcontractor", "Appraiser", "Adjuster Firm", "Other"
  phone          String?
  email          String?
  address        String?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts       ResourceContact[]
  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("resource_companies")
}

model ResourceContact {
  id        String   @id @default(uuid())
  companyId String
  name      String
  role      String?  // "Sales Rep", "Estimator", "Field Adjuster", "Owner", etc.
  phone     String?
  email     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   ResourceCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  @@index([companyId])
  @@map("resource_contacts")
}
